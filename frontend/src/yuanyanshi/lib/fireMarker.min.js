!function(t){"use strict";function e(t,e){function i(t,e,i){return parseInt("0x"+t.slice(e,i))}var n,o,a;if(e=void 0===e?1:e,"number"==typeof t?t=function(t){if(t.length<6)for(var e=6-t.length,i=0;i<e;i++)t="0"+t;return t}(t=t.toString(16)):"string"==typeof t&&(t=t.slice(1)),6!=t.length)throw"wrong color length: color 0xffffff, or #ffffff length = 6";return n=i(t,0,2),o=i(t,2,4),a=i(t,4,6),"rgba("+n+", "+o+", "+a+", "+e+")"}function i(t,e,i,n){var o=null;if(i[t.styleName]?o=i[t.styleName]:n&&i[n]?o=i[n]:i[t.type]&&(o=i[t.type]),o){var a=e||t;Object.keys(o).forEach(function(t){void 0===a[t]&&(a[t]=o[t])})}}CanvasRenderingContext2D.prototype.roundRect||(CanvasRenderingContext2D.prototype.roundRect=function(t,e,i,n,o){return this.beginPath(),this.moveTo(t+o,e),this.arcTo(t+i,e,t+i,e+n,o),this.arcTo(t+i,e+n,t,e+n,o),this.arcTo(t,e+n,t,e,o),this.arcTo(t,e,t+i,e,o),this.closePath(),this});var n=function(t){var e=this;e.style={},e.setStyle(t),e.ctx=document.createElement("canvas").getContext("2d"),e.isDrawing=!1,e._elements=[],e.ctx.canvas.width=e.style.width,e.ctx.canvas.height=e.style.height};n.prototype.setStyle=function(t){var e=this;t&&(e.style={},this.style=Object.assign(e.style,{width:256,height:128,color:4473924,fontColor:0,font:"24px 微软雅黑",elements:[],background:{color:16777215,alpha:0}},t))},n.prototype.readElementSytle=function(t){var i=this;void 0!==t.color&&(i.ctx.fillStyle=e(t.color,t.alpha)),void 0!==t.strokeColor&&(i.ctx.strokeStyle=e(t.strokeColor,t.strokeAlpha)),t.lineWidth&&(i.ctx.lineWidth=t.lineWidth),t.textBaseline?i.ctx.textBaseline=t.textBaseline:i.ctx.textBaseline="hanging",t.shadow?(void 0!==t.shadow.offsetX&&(i.ctx.shadowOffsetX=t.shadow.offsetX),void 0!==t.shadow.offsetY&&(i.ctx.shadowOffsetY=t.shadow.offsetY),void 0!==t.shadow.blur&&(i.ctx.shadowBlur=t.shadow.blur),void 0!==t.shadow.color&&(i.ctx.shadowColor=e(t.shadow.color,t.shadow.alpha))):(i.ctx.shadowBlur=0,i.ctx.shadowOffsetX=0,i.ctx.shadowOffsetY=0)},n.prototype.getValue=function(t,e,i){var n=t[e],o={x:0,y:0};return!t.groups||"x"!=e&&"y"!=e||(o=t.groups.reduce(function(t,e){return{x:t.x+e.x,y:t.y+e.y}},o)),i?n+o.x:n+o.y},n.prototype.getStyleByName=function(t){var e=null;return function i(n){if(n.elements&&!e)for(var o=0;o<n.elements.length;o++){var a=n.elements[o];a.name==t&&(e=a),i(a)}}(this.style),e},n.prototype.drawBackground=function(){this.ctx.fillStyle=e(this.style.background.color,this.style.background.alpha),this.ctx.fillRect(0,0,this.style.width,this.style.height)},n.prototype.drawRoundRect=function(t,e){var i=this;if(i.readElementSytle(t),t.width&&t.height){var n=i.getValue(t,"x",!0),o=i.getValue(t,"y"),a=i.getValue(t,"width",!0),r=i.getValue(t,"height");i.ctx.beginPath(),e?i.ctx.roundRect(n,o,a,r,t.radius||5):i.ctx.rect(n,o,a,r),i.ctx.closePath(),void 0!==t.color&&i.ctx.fill(),void 0!==t.lineWidth&&void 0!==t.strokeColor&&i.ctx.stroke(),i.next()}else i.next()},n.prototype.drawCircle=function(t){var e=this;if(void 0!==t.radius&&void 0!==t.point){e.readElementSytle(t);var i=e.getValue(t.point,"x",!0),n=e.getValue(t.point,"y");e.ctx.beginPath(),e.ctx.arc(i,n,t.radius,0,2*Math.PI,!0),e.ctx.closePath(),void 0!==t.color&&e.ctx.fill(),void 0!==t.lineWidth&&void 0!==t.strokeColor&&e.ctx.stroke(),e.next()}},n.prototype.drawShape=function(t){var e=this;if(!(void 0===t.points&&t.points.length<2)){e.readElementSytle(t),e.ctx.beginPath();for(var i=0;i<t.points.length;i++){var n=e.getValue(t.points[i],"x",!0),o=e.getValue(t.points[i],"y");0===i?e.ctx.moveTo(n,o):e.ctx.lineTo(n,o)}!1!==t.close&&t.points.length>2&&e.ctx.closePath(),void 0!==t.lineWidth&&void 0!==t.strokeColor&&e.ctx.stroke(),void 0!==t.color&&!1!==t.close&&e.ctx.fill(),e.next()}},n.prototype.drawImage=function(t){function e(){i.readElementSytle(t);var e=i.getValue(t,"x",!0),n=i.getValue(t,"y");if(t.width&&t.height){var o=i.getValue(t,"width",!0),a=i.getValue(t,"height");i.ctx.drawImage(t.image,e,n,o,a)}else i.ctx.drawImage(t.image,e,n)}var i=this,n=null;t.image?(e(t.img),i.next()):((n=new Image).src=t.url,n.onload=function(){t.image=n,e(),i.next()})},n.prototype.drawText=function(t){var e=this,i=t.font||e.style.font,n=i.match(/\d+/);n.length>0&&parseInt(n[0]),e.readElementSytle(t),e.ctx.font=i;var o=e.getValue(t,"x",!0),a=e.getValue(t,"y");t.lineWidth&&(e.ctx.lineWidth=t.lineWidth,e.ctx.strokeStyle=t.strokeColor||16777215,e.ctx.strokeText(t.text,o,a)),e.ctx.fillText(t.text,o,a),e.next()},n.prototype.drawElement=function(t){var e=this;if(!1!==t.visible){if(t.groups)for(var i=0;i<t.groups.length;i++)if(!1===t.groups[i].visible)return void e.next();switch(t.type){case"image":this.drawImage(t);break;case"text":this.drawText(t);break;case"roundRect":this.drawRoundRect(t,!0);break;case"rect":this.drawRoundRect(t,!1);break;case"circle":this.drawCircle(t);break;case"shape":this.drawShape(t)}}else this.next()},n.prototype.normalizeStyle=function(t,e){var i=this;if(t.elements)for(var n=0;n<t.elements.length;n++){var o=t.elements[n];if("group"==o.type){var a=[];e?(a=e.slice()).push(o):a=[o],i.normalizeStyle(t.elements[n],a)}else e&&(o.groups=e),i._elements.push(o)}},n.prototype.next=function(){var t=this;++t.index<t._elements.length?t.drawElement(t._elements[t.index]):(t.isDrawing=!1,t.callback&&t.callback())},n.prototype.init=function(t){t&&(this.callback=t),this.update()},n.prototype.update=function(t){var e=this;if(!e.isDrawing){t&&e.setStyle(t),e._elements=[],e.normalizeStyle(e.style),e.isDrawing=!0,e.index=-1;var i=e.style.width,n=e.style.height;i!=e.ctx.canvas.width&&(e.ctx.canvas.width=i),n!=e.ctx.canvas.height&&(e.ctx.canvas.height=n),e.ctx.clearRect(0,0,i,n),e.drawBackground(t),e.next()}};var o=window.devicePixelRatio,a=function(t,e){this.description=new u(t),this.canvasDrawer=new n(this.description.description)},r={canvas:{},width:{},height:{}};a.prototype.init=function(t){var e=this;this.canvasDrawer.init(function(){t&&t(e.canvasDrawer.ctx.canvas),e.canvasDrawer.callback=null})},a.prototype.rebuild=function(t){this.description=new u(t),this.canvasDrawer.update(this.description.description)},r.canvas.get=function(){return this.canvasDrawer.ctx.canvas},r.width.get=function(){return this.description.description.width},r.height.get=function(){return this.description.description.height},a.prototype.getStyleByName=function(t){return this.canvasDrawer.getStyleByName(t)},a.prototype.updateText=function(t,e){var i=this.getStyleByName(t);if(i){var n=i.width;s.font=i.font;var o=s.measureText(e).width,a=o-n;switch(i.align){case"right":i.x-=a;break;case"center":i.x-=a/2}i.text=e,i.width=o,this.canvasDrawer.update()}},a.prototype.updateImage=function(t,e){var i=this.getStyleByName(t);i&&("string"==typeof e?(delete i.image,i.url=e):e instanceof Image&&(i.image=e),this.canvasDrawer.update())},a.prototype.updateFrame=function(t,e){var i=this.getStyleByName(t);i&&Object.assign(i,e),this.canvasDrawer.update()},Object.defineProperties(a.prototype,r);var s=document.createElement("canvas").getContext("2d"),c=function(t){this.config=t,t&&(this.name=t.name),this.description={}},h={width:{},height:{}};h.width.get=function(){return this.description.width},h.height.get=function(){return this.description.height},Object.defineProperties(c.prototype,h);var l=function(t){function e(e){t.call(this,e),this.description=e,e.url&&(this.backgroundImage={type:"image",name:"backgroundImage",url:e.url,x:0,y:0})}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(c),p=function(t){function e(e,n){t.call(this,e),this.style=n,this.description={type:"group",name:e.name,x:0,y:0,elements:[]},i(e,null,n,"textGroup"),this.parse()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getTextProp=function(t,e,i){return void 0!==t[e]?t[e]:void 0!==this.config[e]?this.config[e]:i},e.prototype.parse=function(){var t=this,e=0,n=0,a=t.description;if(a.elements.length=0,t.config.elements.length){t.config.elements.forEach(function(r,c){var h={};h.type="text",h.name=r.name||"text_"+c,h.text=r.text,i(r,null,t.style,"text"),h.color=t.getTextProp(r,"color",0),h.strokeColor=t.getTextProp(r,"strokeColor",16777215),h.align=t.getTextProp(r,"align","center");var l=t.getTextProp(r,"size",18)*o,p=t.getTextProp(r,"font","Arial"),d=t.getTextProp(r,"weight","normal"),g=t.getTextProp(r,"style","");h.font=g+" "+d+" "+l+"px "+p,s.font=h.font;var u=s.measureText(h.text).width;u>n&&(n=u),h.width=u,h.height=s.measureText("M").width,h.space=t.getTextProp(r,"space",4)*o,h.lineWidth=t.getTextProp(r,"lineWidth",Math.max(l/12,1)),e+=h.height+h.lineWidth+(c<t.config.elements.length-1?h.space:0),a.elements.push(h)});var r=0;a.elements.forEach(function(t,e){if(e>0){var i=a.elements[e-1];r+=i.height+i.space}switch(t.align){case"left":t.x=0,t.y=r;break;case"right":t.x=n-t.width,t.y=r;break;case"center":t.x=(n-t.width)/2,t.y=r}}),a.width=n,a.height=e}},e}(c),d=function(t){function e(e,n){t.call(this,e),this.description={type:"image",x:0,y:0},i(e,null,n,"image"),this.description=Object.assign(this.description,e),this.description.width*=o,this.description.height*=o,this.description.space*=o}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(c),g=function(t){function e(e,n){t.call(this,e),this.style=n,this.description={type:"group",name:e.name,x:0,y:0,elements:[]},i(e,null,n,"container"),this.parse()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.parse=function(){var t=this;t.config.elements.length&&t.config.elements.forEach(function(i,n){switch(i.type){case"textGroup":var o=new p(i,t.style);!1!==i.visible&&t.description.elements.push(o.description);break;case"image":var a=new d(i,t.style);!1!==i.visible&&t.description.elements.push(a.description);break;case"container":var r=new e(i,t.style);!1!==i.visible&&t.description.elements.push(r.description)}}),t.locate()},e.prototype.getMaxSize=function(){var t=0,e=0;return this.description.elements.forEach(function(i){i.width>t&&(t=i.width),i.height>e&&(e=i.height)}),{maxWidth:t,maxHeight:e}},e.prototype.locate=function(){var t=this,e=t.getMaxSize(),i="horizontal"===t.config.flowType,n=void 0===t.config.margin?5:t.config.margin,a=n*=o,r=n,s=!1;t.description.elements.forEach(function(n,c){if(!1!==n.enabled){s=c===t.description.elements.length-1;var h=(t.config.elements[c].space||5)*o;if(i){switch(n.x=a,t.config.elements[c].align){case"top":case"left":n.y=r;break;case"bottom":case"right":n.y=r+e.maxHeight-n.height;break;default:n.y=r+(e.maxHeight-n.height)/2}a+=n.width+(s?0:h)}else{switch(n.y=r,t.config.elements[c].align){case"top":case"left":n.x=a;break;case"bottom":case"right":n.x=a+e.maxWidth-n.width;break;default:n.x=a+(e.maxWidth-n.width)/2}r+=n.height+(s?0:h)}}}),t.description.width=(i?a:e.maxWidth)+n*(i?1:2),t.description.height=(i?e.maxHeight:r)+n*(i?2:1),t.config.frame&&t.parseFrame()},e.prototype.parseFrame=function(){var t=this,e=t.description.width,n=t.description.height,o=e<n?e:n,a=Math.max(o/(t.config.frame.extend||20),3),r=Math.min(o/25,1),s=a+r;t.description.width+=2*s,t.description.height+=2*s;var c=t.config.margin||5,h=2*c,l={type:"roundRect",name:"frame",x:c,y:c,color:16777215,strokeColor:3355443,alpha:.4,width:t.description.width-h,height:t.description.height-h,radius:a,lineWidth:r};Object.assign(l,t.config.frame),i(t.config.frame,l,t.style,"frame"),t.description.elements.forEach(function(t){t.x+=s,t.y+=s}),t.description.elements.unshift(l)},e}(c),u=function(t){this.description={elements:[]},this.style=t.style,t.background&&(this.background=new l(t.background),this.description.background=this.background.description),this.container=new g(t.container,this.style),this.description.width=this.container.width,this.description.height=this.container.height,this.background&&this.background.backgroundImage&&(this.background.backgroundImage.width=this.container.width,this.background.backgroundImage.height=this.container.height,this.description.elements.unshift(this.background.backgroundImage)),this.description.elements.push(this.container.description)};t.Painter=a,t._ctx_=s}(this.fengmap=this.fengmap||{}),function(t){function e(t,e,n){var o=this;o.config={style:{text:{size:12,font:"微软雅黑"}},container:{type:"container",flowType:"vertical",frame:{name:"f1",color:16777215,alpha:.8},elements:[{type:"textGroup",elements:[{text:"test",name:"t1"}]}]}},e instanceof Array&&o.setTexts(e,!0),n&&(o.config.container.frame.visible=n.frameVisible);var a=new fengmap.Painter(o.config);o.content=a,fengmap.FMSprite.call(this,{map:t,width:a.width/i,height:a.height/i,anchor:"bottom"}),o.colliderScale=.7,o.width_=o.width*o.colliderScale,o.height_=o.height*o.colliderScale,o.fm_={},o.fm_.visible=!0,o.forceVisible_=!0,o.o3d_=this,a.init(function(){o.material.map=new fm.Texture(a.canvas),o.material.map.minFilter=1006,o.material.map.magFilter=1003,o.material.map.needsUpdate=!0})}var i=window.devicePixelRatio;e.prototype.constructor=e,e.prototype=Object.create(fengmap.FMSprite.prototype,{setTexts:{value:function(t,e){if(this.config.container.elements[0].elements=t,!e){this.content.rebuild(this.config),this.material.map.needsUpdate=!0;var n=this.content.width/i,o=this.content.height/i;this.setSize(n,o),this.width_=n*this.colliderScale,this.height_=o*this.colliderScale}}},updateContent:{value:function(t){if(t=t||{},this.content&&t.type){switch(t.type){case"text":this.content.updateText(t.name,t.value);break;case"image":this.content.updateImage(t.name,t.value);break;case"frame":this.content.updateFrame(t.name,t.value)}this.material.map.needsUpdate=!0}}},setScale:{value:function(t){this.originScale.setScalar(t)}},updateText:{value:function(t,e){this.content.updateText(t,e),this.material.map.needsUpdate=!0}},clone:{value:function(){return new e(this.map,this.config)}}}),Object.assign(e.prototype,fengmap.MapLabel.generalFunctions,{updateScreenSize:function(){},alwaysShow:function(t,e){var i=fengmap.MapUtil.getAlias(this.fm_),n=fengmap.FMRenderOrder[i];e=void 0==e?void 0==n?47:n:e,t=void 0==t||t,this.material&&(this.material.depthTest=!t,this.renderOrder=t?e:0)}}),t.FMCompositionMarker=e}(this.fengmap=this.fengmap||{});