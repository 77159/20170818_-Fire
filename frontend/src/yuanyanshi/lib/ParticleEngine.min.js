function Tween(t,e){this.times=t||[],this.values=e||[]}function Particle(){this.position=new fm.Vector3,this.velocity=new fm.Vector3,this.acceleration=new fm.Vector3,this.angle=0,this.angleVelocity=0,this.angleAcceleration=0,this.size=16,this.color=new fm.Color,this.opacity=1,this.age=0,this.alive=0,this.lastPos=new fm.Vector3,this.worldVelocity=new fm.Vector3,this.mesh=null}function ParticleEngine(){this.positionStyle=Type.CUBE,this.positionBase=new fm.Vector3,this.positionSpread=new fm.Vector3,this.positionRadius=0,this.velocityStyle=Type.CUBE,this.velocityBase=new fm.Vector3,this.velocitySpread=new fm.Vector3,this.speedBase=0,this.speedSpread=0,this.accelerationBase=new fm.Vector3,this.accelerationSpread=new fm.Vector3,this.angleBase=0,this.angleSpread=0,this.angleVelocityBase=0,this.angleVelocitySpread=0,this.angleAccelerationBase=0,this.angleAccelerationSpread=0,this.sizeBase=0,this.sizeSpread=0,this.sizeTween=new Tween,this._pause=!0,this.initialized=!1,this.customMesh=null,this.meshGoup=new fm.Group,this.worldValues=null,this.worldRecord=!1,this.colorBase=new fm.Vector3(0,1,.5),this.colorSpread=new fm.Vector3(0,0,0),this.colorTween=new Tween,this.opacityBase=1,this.opacitySpread=0,this.opacityTween=new Tween,this.blendStyle=fm.NormalBlending,this.particleArray=[],this.particlesPerSecond=100,this.particleDeathAge=1,fengmap&&(this.scene=fengmap.Map.instance.mapScene.getO3dScene()),this.emitterAge=0,this.emitterAlive=!0,this.emitterDeathAge=Number.MAX_VALUE,this.particleCount=this.particlesPerSecond*Math.min(this.particleDeathAge,this.emitterDeathAge),this.particleGeometry=new fm.BufferGeometry,this.particleTexture=null,this.particleMaterial=new fm.ShaderMaterial({uniforms:{texture:{type:"t",value:this.particleTexture}},vertexShader:particleVertexShader,fragmentShader:particleFragmentShader,transparent:!0,blending:fm.NormalBlending,depthTest:!0,lights:!1}),this.particleMesh=new fm.Mesh,this.particleMesh.renderOrder=101,this.updateCallback=this._update.bind(this);var t=this;fengmap.Map.instance.on("update",t.updateCallback)}particleVertexShader=["attribute vec3  customColor;","attribute float customOpacity;","attribute float customSize;","attribute float customAngle;","attribute float customVisible;","varying vec4  vColor;","varying float vAngle;","void main()","{","if ( customVisible > 0.5 )","vColor = vec4( customColor, customOpacity );","else","vColor = vec4(0.0);","vAngle = customAngle;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_PointSize = customSize * ( 300.0 / length( mvPosition.xyz ) );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),particleFragmentShader=["uniform sampler2D texture;","varying vec4 vColor;","varying float vAngle;","void main()","{","vec4 color = vColor;","#ifdef TEXTURE","float c = cos(vAngle);","float s = sin(vAngle);","vec2 rotatedUV = vec2(c * (gl_PointCoord.x - 0.5) + s * (gl_PointCoord.y - 0.5) + 0.5,","c * (gl_PointCoord.y - 0.5) - s * (gl_PointCoord.x - 0.5) + 0.5);","color = color * texture2D( texture,  rotatedUV );","#endif","#ifdef USE_MESH","color = vec4(0.0);","#endif","gl_FragColor = color;","}"].join("\n"),Tween.prototype.lerp=function(t){for(var e=0,i=this.times.length;i>e&&t>this.times[e];)e++;if(0==e)return this.values[0];if(e==i)return this.values[i-1];var s=(t-this.times[e-1])/(this.times[e]-this.times[e-1]);return this.values[0]instanceof fm.Vector3?this.values[e-1].clone().lerp(this.values[e],s):this.values[e-1]+s*(this.values[e]-this.values[e-1])},Particle.prototype.update=function(t,e){var i=e.particleMesh.getWorldPosition();if(e.worldEffectTween.times.length>0&&(e.worldRecord||(e.worldRecord=!0,e.worldValues=[],e.worldEffectTween.values.forEach(function(t){e.worldValues.push(t.clone())})),e.worldSpace&&e.worldEffectTween.values.forEach(function(t,i){var s=e.worldValues[i].clone();t.copy(e.particleMesh.inverseTransformVector(s))}),this.worldVelocity=e.worldEffectTween.lerp(this.age)),this.position.add(this.velocity.clone().multiplyScalar(t)).sub(i.clone().sub(this.lastPos)).add(this.worldVelocity),this.lastPos=i,this.velocity.add(this.acceleration.clone().multiplyScalar(t)),this.angle+=.01745329251*this.angleVelocity*t,this.angleVelocity+=.01745329251*this.angleAcceleration*t,this.age+=t,e.sizeTween.times.length>0&&(this.size=e.sizeTween.lerp(this.age)),e.colorTween.times.length>0){var s=e.colorTween.lerp(this.age);this.color=(new fm.Color).setHSL(s.x,s.y,s.z)}e.opacityTween.times.length>0&&(this.opacity=e.opacityTween.lerp(this.age));var r=this;if(r.mesh){r.mesh.position.copy(r.position);var a=this.angle;a>360&&(a=0),r.mesh.rotation.y=a,r.mesh.rotation.z=-a,r.mesh.scale.set(r.size,r.size,r.size),r.mesh.material.color.copy(r.color),r.mesh.material.opacity=r.opacity}};var Type=Object.freeze({CUBE:1,SPHERE:2});ParticleEngine.Type=Type,ParticleEngine.Tween=Tween,ParticleEngine.prototype.setValues=function(t){if(void 0!==t){this.initialized=!1,this.sizeTween=new Tween,this.colorTween=new Tween,this.opacityTween=new Tween,this.worldEffectTween=new Tween;for(var e in t)this[e]=t[e];this.particleArray=[],this.emitterAge=0,this.emitterAlive=!0,this.particleCount=this.particlesPerSecond*Math.min(this.particleDeathAge,this.emitterDeathAge),this.particleGeometry=null,this.particleMaterial=new fm.ShaderMaterial({uniforms:{texture:{type:"t",value:this.particleTexture}},vertexShader:particleVertexShader,fragmentShader:particleFragmentShader,transparent:!0,blending:fm.AdditiveBlending,depthWrite:!1}),this.customMesh=t.customMesh,this.particleMaterial.defines={TEXTURE:null!=this.particleTexture,USE_MESH:null!=this.customMesh},this.destroy(!0),this.particleMesh=new fm.Points}},ParticleEngine.prototype.randomValue=function(t,e){return t+e*(Math.random()-.5)},ParticleEngine.prototype.randomVector3=function(t,e){var i=new fm.Vector3(Math.random()-.5,Math.random()-.5,Math.random()-.5);return(new fm.Vector3).addVectors(t,(new fm.Vector3).multiplyVectors(e,i))},ParticleEngine.prototype.resetParticle=function(t){if(this.positionStyle==Type.CUBE&&(t.position=this.randomVector3(this.positionBase,this.positionSpread)),this.positionStyle==Type.SPHERE){var e=2*Math.random()-1,i=6.2832*Math.random(),s=Math.sqrt(1-e*e),r=new fm.Vector3(s*Math.cos(i),s*Math.sin(i),e);t.position=(new fm.Vector3).addVectors(this.positionBase,r.multiplyScalar(this.positionRadius))}if(t.lastPos=this.particleMesh.getWorldPosition(),this.customMesh&&!t.mesh){if(this.emissive=this.emissive||.7,this.customMesh instanceof fm.Mesh)t.mesh=this.customMesh.clone();else if(this.customMesh instanceof Array)if(this.customMesh.length>2&&"number"==typeof this.customMesh[1]){for(var s=Math.random(),a=-1,o=0,l=1;l<this.customMesh.length;l++)if(o+=this.customMesh[l],o>=s){a=l-1;break}-1==a&&(a=this.customMesh.length-1),t.mesh=this.customMesh[a].clone()}else t.mesh=this.customMesh[Math.floor(Math.random()*this.customMesh.length)].clone();t.mesh.material=t.mesh.material.clone(),t.mesh.material.emissive.setRGB(this.emissive,this.emissive,this.emissive),t.mesh.material.depthWrite=!1,this.meshGoup.add(t.mesh),t.mesh.material.transparent=!0}if(this.velocityStyle==Type.CUBE&&(t.velocity=this.randomVector3(this.velocityBase,this.velocitySpread)),this.velocityStyle==Type.SPHERE){var n=(new fm.Vector3).subVectors(t.position,this.positionBase),h=this.randomValue(this.speedBase,this.speedSpread);t.velocity=n.normalize().multiplyScalar(h)}t.acceleration=this.randomVector3(this.accelerationBase,this.accelerationSpread),t.angle=this.randomValue(this.angleBase,this.angleSpread),t.angleVelocity=this.randomValue(this.angleVelocityBase,this.angleVelocitySpread),t.angleAcceleration=this.randomValue(this.angleAccelerationBase,this.angleAccelerationSpread),t.size=this.randomValue(this.sizeBase,this.sizeSpread);var c=this.randomVector3(this.colorBase,this.colorSpread);t.color=(new fm.Color).setHSL(c.x,c.y,c.z),t.opacity=this.randomValue(this.opacityBase,this.opacitySpread),t.age=0,t.alive=0},ParticleEngine.prototype.createParticle=function(){var t=new Particle;return this.resetParticle(t),t},ParticleEngine.prototype.initialize=function(){this.initialized=!0;for(var t=[],e=[],i=[],s=[],r=[],a=[],o=0;o<this.particleCount;o++){this.particleArray[o]=this.createParticle();var l=this.particleArray[o];t.push(l.position.x,l.position.y,l.position.z),e.push(l.alive),i.push(l.color.r,l.color.g,l.color.b),s.push(l.opacity),r.push(l.size),a.push(l.angle)}this.particleGeometry=new fm.BufferGeometry,this.particleGeometry.addAttribute("position",new fm.BufferAttribute(new Float32Array(t),3)),this.particleGeometry.addAttribute("customVisible",new fm.BufferAttribute(new Float32Array(e),1)),this.particleGeometry.addAttribute("customColor",new fm.BufferAttribute(new Float32Array(i),3)),this.particleGeometry.addAttribute("customOpacity",new fm.BufferAttribute(new Float32Array(s),1)),this.particleGeometry.addAttribute("customSize",new fm.BufferAttribute(new Float32Array(r),1)),this.particleGeometry.addAttribute("customAngle",new fm.BufferAttribute(new Float32Array(a),1)),this.particleMaterial.blending=this.blendStyle,this.particleMesh=new fm.Points(this.particleGeometry,this.particleMaterial),this.particleMesh.dynamic=!0,this.particleMesh.alphaTest=.5,this.particleMesh.add(this.meshGoup),this.scene.add(this.particleMesh),console.log("ParticleEngine initialize.")},ParticleEngine.prototype.update=function(t){if(this.initialized&&(!this._pause||this._stop)){for(var e=[],i=0;i<this.particleCount;i++)this.particleArray[i].alive&&(this.particleArray[i].update(t,this),this.particleArray[i].age>this.particleDeathAge&&(this.particleArray[i].alive=0,e.push(i)),this.particleGeometry.attributes.position.array[3*i]=this.particleArray[i].position.x,this.particleGeometry.attributes.position.array[3*i+1]=this.particleArray[i].position.y,this.particleGeometry.attributes.position.array[3*i+2]=this.particleArray[i].position.z,this.particleGeometry.attributes.customVisible.array[i]=this.particleArray[i].alive,this.particleGeometry.attributes.customColor.array[3*i]=this.particleArray[i].color.r,this.particleGeometry.attributes.customColor.array[3*i+1]=this.particleArray[i].color.g,this.particleGeometry.attributes.customColor.array[3*i+2]=this.particleArray[i].color.b,this.particleGeometry.attributes.customOpacity.array[i]=this.particleArray[i].opacity,this.particleGeometry.attributes.customSize.array[i]=this.particleArray[i].size,this.particleGeometry.attributes.customAngle.array[i]=this.particleArray[i].angle,this.particleGeometry.attributes.position.needsUpdate=!0,this.particleGeometry.attributes.customVisible.needsUpdate=!0,this.particleGeometry.attributes.customColor.needsUpdate=!0,this.particleGeometry.attributes.customOpacity.needsUpdate=!0,this.particleGeometry.attributes.customSize.needsUpdate=!0,this.particleGeometry.attributes.customAngle.needsUpdate=!0);if(this.emitterAlive){if(this.emitterAge<this.particleDeathAge&&!this._pause){var s=Math.round(this.particlesPerSecond*(this.emitterAge+0)),r=Math.round(this.particlesPerSecond*(this.emitterAge+t));r>this.particleCount&&(r=this.particleCount);for(var i=s;r>i;i++)this.particleArray[i].alive=1}if(!this._pause)for(var a=0;a<e.length;a++){var i=e[a];this.resetParticle(this.particleArray[i]),this.particleArray[i].alive=1,this.particleGeometry.attributes.position.array[3*i]=this.particleArray[i].position.x,this.particleGeometry.attributes.position.array[3*i+1]=this.particleArray[i].position.y,this.particleGeometry.attributes.position.array[3*i+2]=this.particleArray[i].position.z}this.emitterAge+=t,this.emitterAge>this.emitterDeathAge&&(this.emitterAlive=!1),this.forceUpdate&&fengmap&&(fengmap.Map.instance.updateCountDown_=0)}}},ParticleEngine.prototype._update=function(t){this.update(t)},ParticleEngine.prototype.stop=function(){this._pause=!0,this._stop=!0},ParticleEngine.prototype.pause=function(){this._stop=!1,this._pause=!0},ParticleEngine.prototype.start=function(){this.initialized||this.initialize(),this._pause=!1,this._stop=!1,this.emitterAge=0},ParticleEngine.prototype.restart=function(){this.stop(),this.start()},ParticleEngine.prototype.destroy=function(t){var e=this;if(t||fengmap.Map.instance.off("update",e.updateCallback),e.customMesh)for(;e.meshGoup.children.length>0;)e.meshGoup.remove(e.meshGoup.children[0]);e.scene.remove(e.particleMesh)},ParticleEngine.prototype.setPosition=function(t){switch(arguments.length){case 1:this.particleMesh.position.copy(t);break;case 3:this.particleMesh.position.set(arguments[0],arguments[1],arguments[2])}},ParticleEngine.prototype.setTransform=function(t){utils.sameTransform(this.particleMesh,t)};